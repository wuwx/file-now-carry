<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件直传</title>
</head>
<body>

    <input type="file" id="inputFile">
    <button id="linkBtn">生成连接</button>

    <script src="js/jquery.min.js"></script>
    <script src="js/app.js"></script>
    <script>

        let app = new Application();
        app.setOnOpen(function () {

            console.log('websocket connected');

            let page = new PageClass();
            let inputFile = document.getElementById('inputFile');
            let linkBtn = document.getElementById('linkBtn');

            inputFile.onchange = function () {
                let selectFile = inputFile.files[0];
                page.setFile(selectFile);
            };
            linkBtn.onclick = function () {


                if (! page.file) {

                    alert('你还没有选择文件');
                    return;
                }

                // 开始创建房间
                page.createRoom();
            };

            function PageClass(ws)
            {
                let that = this;
                this.chunkSize = 10;
                this.file = null;


                this.onmessage = function(event) {
                    // 处理数据
                    let data = event.data;
                    let msg = that.newProtocol().parse(data);

                    switch (msg.type) {

                        case Application.FILE_PRE_UPLOAD:
                            // 上传之前，把文件大小，切片端告诉后端
                            that.ws.send(that.newProtocol(Application.MessageTypeEnum.FILE_PRE_UPLOAD, '传输文件信息', that.file).toJson());
                            break;
                        case Application.FILE_UPLOADING:

                            // 让后端告诉我要取第几块的数据，前端只负责读取
                            let Blob = that.readChunkContents(msg.data.index);
                            that.ws.send(Blob);
                            break;
                        case Application.FILE_UPLOADED:
                            // 传输完成，代表对方接受完成
                            break;

                    }

                };

                this.setFile = function (file) {
                    this.file = file;

                    return this;
                };

                // 创建房间
                this.createRoom = function () {

                    let fileObj = {
                        fileSize: this.file.size,
                        fileName: this.file.name,
                        fileType: this.file.type
                    };

                    console.log(fileObj);
                    app.ws.send(app.newProtocol(Application.MessageTypeEnum.CREATED_ROOM, '创建房间', fileObj).toJson())
                };
                this.readChunkContents = function (chunkIndex) {

                    if (! this.file) {

                        alert('未选择文件');
                        return;
                    }

                    let blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice;
                    let start = chunkIndex * this.chunkSize;
                    let end = start + this.chunkSize;

                    return blobSlice.call(this.file, start, end);
                };
            }
        });

        app.setOnClose(function (e) {

            let msg = app.newProtocol().parse(e.reason);

            alert(msg.msg || '服务器关闭了连接');
        });
    </script>
</body>
</html>