<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件直传</title>
    <link rel="stylesheet" href="css/toastr.min.css">
</head>
<body>

    <div id="container">
        <input type="file" v-on:change="selectFile">
        <button id="linkBtn" v-on:click="createLink">生成连接</button>
        <span><a target="_blank" v-if="shareLink" v-bind:href="shareLink">{{ shareLink }}</a></span>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/vue.js"></script>
    <script src="js/app.js"></script>
    <script src="js/toastr.min.js"></script>
    <script src="layui/layui.js"></script>
    <script>

        let vue = new Vue({
            el: '#container',
            data: {
                file: null,
                app: new Application(),
                shareLink: null,
            },
            methods: {

                selectFile: function (e) {

                    this.file = e.target.files[0];
                },
                createLink: function () {

                    if (! this.file) {

                        alert('你还没有选择文件');
                        return;
                    }

                    // 开始创建房间
                    this.createRoom();
                }
                ,
                createRoom: function () {

                    let fileObj = {
                        fileSize: this.file.size,
                        fileName: this.file.name,
                        fileType: this.file.type
                    };

                    console.log(fileObj);
                    this.app.ws.send(this.app.newProtocol(Application.MessageTypeEnum.CREATED_ROOM, '创建房间', fileObj).toJson())
                },
                readChunkContents: function (chunkIndex) {

                    if (! this.file) {

                        alert('未选择文件');
                        return;
                    }

                    let blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice;
                    let start = chunkIndex * this.chunkSize;
                    let end = start + this.chunkSize;

                    return blobSlice.call(this.file, start, end);
                }
            },
            mounted: function () {

                let that = this;
                console.log(that.app);
                that.app.setOnOpen(function () {

                    console.log('websocket connected');
                });


                that.app.setOnMessage(function(event) {
                    // 处理数据
                    let data = event.data;
                    let msg = that.app.newProtocol().parse(data);

                    console.log(msg);
                    switch (msg.type) {

                        case Application.MessageTypeEnum.CREATED_ROOM:
                            // 上传之前，把文件大小，切片端告诉后端
                            let url = window.location.href.split('/').slice(0,-1).join('/');

                            that.shareLink = url + '/client.html?link=' + msg.data.shareLink;
                            toastr.success('创建连接成功，拿去分享吧');
                            break;
                        case Application.FILE_UPLOADED:
                            // 传输完成，代表对方接受完成
                            break;

                    }

                });

                that.app.setOnClose(function (e) {

                    let msg = that.app.newProtocol().parse(e.reason);

                    alert(msg.msg || '服务器关闭了连接');
                });
            }
        });
    </script>
</body>
</html>